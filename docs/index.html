<!DOCTYPE html>
<html lang="fr" data-theme="dark">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>RAG Bible</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
  <script src="https://unpkg.com/htmx.org@2.0.4"></script>
  <style>
    :root { --pico-font-size: 100%; }
    body { max-width: 720px; margin: 0 auto; padding: 1rem; }
    .subtitle { color: var(--pico-muted-color); margin-top: -0.5rem; }
    #search-form { position: relative; }
    #search-form input[type="search"] { padding-right: 3rem; }
    .indicator { display: none; text-align: center; padding: 2rem 0; color: var(--pico-muted-color); }
    .htmx-request .indicator { display: block; }
    .htmx-request #results-content { opacity: 0.4; }
    .examples { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1rem; }
    .examples button { font-size: 0.85rem; padding: 0.3rem 0.7rem; cursor: pointer; }
    .score-badge { float: right; font-size: 0.85rem; padding: 0.1rem 0.5rem; border-radius: 4px; background: var(--pico-primary-background); color: var(--pico-primary-inverse); }
    .score-badge[data-label="Tres pertinent"] { background: #2e7d32; }
    .score-badge[data-label="Pertinent"] { background: #1565c0; }
    .score-badge[data-label="Peu pertinent"] { background: #e65100; }
    .score-badge[data-label="Faible pertinence"] { background: #6a6a6a; }
    article { margin-bottom: 1rem; }
    article header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
    .context-block { padding: 0.5rem 0; }
    .context-verse { padding: 0.3rem 0.5rem; margin: 0.2rem 0; font-size: 0.95rem; color: var(--pico-muted-color); }
    .verse-ref { font-weight: bold; margin-right: 0.5rem; font-size: 0.85rem; }
    .matched-verse { background: rgba(255, 255, 255, 0.05); border-left: 3px solid var(--pico-primary); padding-left: 0.7rem; color: var(--pico-color); }
    #server-status { text-align: center; padding: 0.75rem; margin-bottom: 1rem; border-radius: 4px; background: var(--pico-muted-border-color); color: var(--pico-muted-color); font-size: 0.9rem; }
    #server-status.connected { background: #2e7d32; color: #fff; }
    #server-status.error { background: #c62828; color: #fff; }
  </style>
</head>
<body>
  <header>
    <h1>RAG Bible</h1>
    <p class="subtitle">Posez une question sur la Bible et trouvez les versets les plus pertinents.</p>
  </header>

  <div id="server-status">Connexion au serveur...</div>

  <main>
    <form id="search-form" hx-post="/search" hx-target="#results-container" hx-indicator="#results-container">
      <input
        type="search"
        name="query"
        id="query-input"
        placeholder="Ex: Que dit la Bible sur l'amour ?"
        maxlength="300"
        required
        autofocus
      >
    </form>

    <div class="examples">
      <button type="button"
        hx-post="/search" hx-target="#results-container" hx-indicator="#results-container"
        hx-vals='{"query": "Que dit la Bible sur le pardon ?"}'>Que dit la Bible sur le pardon ?</button>
      <button type="button"
        hx-post="/search" hx-target="#results-container" hx-indicator="#results-container"
        hx-vals='{"query": "Comment trouver la paix interieure ?"}'>Comment trouver la paix interieure ?</button>
      <button type="button"
        hx-post="/search" hx-target="#results-container" hx-indicator="#results-container"
        hx-vals='{"query": "Pourquoi Dieu permet-il la souffrance ?"}'>Pourquoi Dieu permet-il la souffrance ?</button>
      <button type="button"
        hx-post="/search" hx-target="#results-container" hx-indicator="#results-container"
        hx-vals='{"query": "Que dit Jesus sur l amour du prochain ?"}'>Que dit Jesus sur l'amour du prochain ?</button>
    </div>

    <div id="results-container">
      <div class="indicator" aria-busy="true">
        Recherche en cours...<br>
        <small>La premiere recherche peut prendre quelques secondes.</small>
      </div>
      <div id="results-content"></div>
    </div>
  </main>

  <script>
    const API_BASE = "https://adedaran-rag-bible.hf.space";
    const MIN_WORDS = 5;

    // Pre-warm: ping the backend and show connection status
    (function () {
      const status = document.getElementById("server-status");
      const start = Date.now();
      const timer = setInterval(function () {
        const elapsed = ((Date.now() - start) / 1000).toFixed(0);
        status.textContent = "Connexion au serveur... (" + elapsed + "s)";
      }, 1000);

      fetch(API_BASE + "/health")
        .then(function (res) {
          clearInterval(timer);
          if (res.ok) {
            const elapsed = ((Date.now() - start) / 1000).toFixed(1);
            status.textContent = "Serveur connecte (" + elapsed + "s)";
            status.classList.add("connected");
            setTimeout(function () { status.style.display = "none"; }, 3000);
          } else {
            throw new Error("HTTP " + res.status);
          }
        })
        .catch(function (err) {
          clearInterval(timer);
          status.textContent = "Impossible de joindre le serveur. Reessayez plus tard.";
          status.classList.add("error");
        });
    })();

    // Rewrite HTMX request URLs to point to the API backend
    document.body.addEventListener("htmx:configRequest", function (evt) {
      var path = evt.detail.path;
      if (path && path.startsWith("/")) {
        evt.detail.path = API_BASE + path;
      }

      // Word count validation
      var params = evt.detail.parameters;
      if (params.query !== undefined && wordCount(params.query) < MIN_WORDS) {
        evt.preventDefault();
      }
    });

    // Word count helpers and input hint
    var input = document.getElementById("query-input");
    var hint = document.createElement("small");
    hint.id = "word-hint";
    hint.style.color = "var(--pico-muted-color)";
    input.parentNode.insertBefore(hint, input.nextSibling);

    function wordCount(text) {
      var cleaned = text.replace(/<[^>]*>/g, "").trim();
      return cleaned ? cleaned.split(/\s+/).length : 0;
    }

    input.addEventListener("input", function () {
      var count = wordCount(this.value);
      if (count > 0 && count < MIN_WORDS) {
        hint.textContent = count + "/" + MIN_WORDS + " mots minimum";
      } else {
        hint.textContent = "";
      }
    });
  </script>
</body>
</html>
